"use strict";var router=require("express").Router(),multer=require("multer"),path=require("path"),File=require("../models/file"),_require=require("uuid"),uuidv4=_require.v4,storage=multer.diskStorage({destination:function(e,r,t){return t(null,"uploads/")},filename:function(e,r,t){t(null,"".concat(Date.now(),"-").concat(Math.round(1e9*Math.random())).concat(path.extname(r.originalname)))}}),upload=multer({storage:storage,limits:{fileSize:1e8}}).single("myfile");router.post("/",function(a,i){upload(a,i,function(r){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r)return e.abrupt("return",i.status(500).send({error:r.message}));e.next=2;break;case 2:return t=new File({filename:a.file.filename,uuid:uuidv4(),path:a.file.path,size:a.file.size}),e.next=5,regeneratorRuntime.awrap(t.save());case 5:n=e.sent,i.json({file:"".concat(process.env.APP_BASE_URL,"/files/").concat(n.uuid)});case 7:case"end":return e.stop()}})})}),router.post("/send",function(r,t){var n,a,i,u,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.body,a=n.uuid,i=n.emailTo,u=n.emailFrom,n.expiresIn,a&&i&&u){e.next=3;break}return e.abrupt("return",t.status(422).send({error:"All fields are required except expiry."}));case 3:return e.next=5,regeneratorRuntime.awrap(File.findOne({uuid:a}));case 5:if((s=e.sent).sender)return e.abrupt("return",t.status(422).send({error:"Email already sent once."}));e.next=8;break;case 8:return s.sender=u,s.receiver=i,e.next=12,regeneratorRuntime.awrap(s.save());case 12:return e.sent,require("../services/emailService")({from:u,to:i,subject:"inShare file sharing",text:"".concat(u," shared a file with you."),html:require("../services/emailTemplate")({emailFrom:u,downloadLink:"".concat(process.env.APP_BASE_URL,"/files/").concat(s.uuid),size:parseInt(s.size/1e3)+" KB",expires:"24 hours"})}),e.abrupt("return",t.json({success:!0}));case 16:case"end":return e.stop()}})}),module.exports=router;
//# sourceMappingURL=files.min.js.map
